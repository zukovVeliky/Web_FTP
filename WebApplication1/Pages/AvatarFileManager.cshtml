@page
@model WebApplication1.Pages.AvatarFileManagerModel
@{
    ViewData["Title"] = "Avatar + FileManager";
}

<h3>Avatar napojeny na FileManager</h3>

<p class="text-muted">
    Vyber obrazek pres FileManager, uprav orez a uloz. Orez je nastaven na format @Model.Settings.CropWidth x @Model.Settings.CropHeight px.
    Vystup o orezu se prida do textoveho souboru.
    Pro posun a zoom v editoru drz klavesu Ctrl.
</p>

<div class="mb-3 d-flex gap-2 flex-wrap">
    <button type="button" class="btn btn-outline-primary" onclick="openAvatarPicker()">
        Vybrat obrazek z FileManageru
    </button>
</div>

@if (!string.IsNullOrWhiteSpace(Model.LastSavedCropUrl))
{
    <div class="alert alert-success py-2">
        Ulozeno: <code>@Model.LastSavedCropUrl</code>
    </div>
}

<form method="post" asp-page-handler="Save" class="mb-4">
    <div asp-validation-summary="All" class="text-danger mb-2"></div>
    @await Html.PartialAsync("~/Areas/Avatar/EditaceAvatara.cshtml", Model.AvatarEditor)
    <div class="mt-3">
        <button type="submit" class="btn btn-primary">Ulozit orez</button>
    </div>
</form>

<h5>Seznam zaznamu z textoveho souboru</h5>

@if (Model.CropLogLines.Count == 0)
{
    <div class="alert alert-secondary py-2">Zatim nejsou ulozene zadne zaznamy.</div>
}
else
{
    <ul class="list-group">
        @foreach (var entry in Model.CropLogLines)
        {
            <li class="list-group-item">
                @if (!string.IsNullOrWhiteSpace(entry.ImageUrl))
                {
                    <div class="mb-2">
                        <img src="@entry.ImageUrl" alt="Cropped avatar" style="max-width: 240px; height: auto; border: 1px solid #ddd; border-radius: 6px;" />
                    </div>
                }
                <code>@entry.Line</code>
            </li>
        }
    </ul>
}

@section Scripts
{
    <script>
        function toBase64UrlUtf8(text) {
            const bytes = new TextEncoder().encode(String(text ?? ''));
            let binary = '';
            for (const b of bytes) binary += String.fromCharCode(b);
            return 'b64:' + btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
        }

        function openAvatarPicker() {
            const picker = toBase64UrlUtf8('1');
            const onlyImages = toBase64UrlUtf8('@(Model.Settings.FileManagerOnlyImages ? "1" : "0")');
            const allowExt = toBase64UrlUtf8('@Model.Settings.FileManagerAllowExt');
            const callback = toBase64UrlUtf8('@Model.CallbackFunctionName');
            const root = '@(Model.Settings.FileManagerRoot ?? string.Empty)';
            const useDefaultRoot = @Model.Settings.FileManagerUseDefaultRoot.ToString().ToLowerInvariant();

            const url = '/FileManager'
                + '?picker=' + encodeURIComponent(picker)
                + '&onlyImages=' + encodeURIComponent(onlyImages)
                + '&allowExt=' + encodeURIComponent(allowExt)
                + '&callback=' + encodeURIComponent(callback)
                + (!useDefaultRoot && root ? '&root=' + encodeURIComponent(toBase64UrlUtf8(root)) : '');

            window.open(url, 'AvatarFileManagerPicker', 'width=1280,height=820,resizable=yes,scrollbars=yes');
        }
    </script>
}
